<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ø³ÙŠØ±ÙØ± - Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Cairo&display=swap');
  body {
    margin: 0; padding: 0;
    font-family: 'Cairo', sans-serif;
    background: #121212;
    color: #eee;
    display: flex;
    flex-direction: column;
    height: 100vh;
  }
  header {
    background: #1f1f1f;
    padding: 20px;
    font-size: 24px;
    font-weight: bold;
    box-shadow: 0 3px 6px rgba(0,0,0,0.7);
    text-align: center;
  }
  nav {
    background: #242424;
    padding: 10px 20px;
    display: flex;
    justify-content: center;
    gap: 15px;
  }
  nav button {
    background: #00c853;
    border: none;
    padding: 10px 18px;
    font-size: 16px;
    border-radius: 6px;
    color: #121212;
    cursor: pointer;
    font-weight: 600;
    transition: background 0.3s ease;
  }
  nav button:hover {
    background: #00e676;
  }

  main {
    flex: 1;
    display: flex;
    padding: 20px;
    gap: 20px;
    overflow: hidden;
  }

  /* ====== Ù‚Ø³Ù… Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… ====== */
  #controlPanel {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 10px;
  }
  .controls {
    width: 220px;
    background: #242424;
    border-radius: 8px;
    padding: 20px;
    box-shadow: 0 0 15px #00c853;
    display: flex;
    flex-direction: column;
    gap: 15px;
  }
  .controls button {
    background: #00c853;
    border: none;
    padding: 12px 15px;
    font-size: 16px;
    border-radius: 6px;
    color: #121212;
    cursor: pointer;
    font-weight: 600;
    transition: background 0.3s ease;
  }
  .controls button:hover {
    background: #00e676;
  }
  #consoleOutput {
  flex: none; /* ÙŠÙ…Ù†Ø¹ Ø§Ù„ØªÙ…Ø¯Ø¯ */
  height: 300px; /* Ø§Ø±ØªÙØ§Ø¹ Ø«Ø§Ø¨Øª */
  background: #000;
  border-radius: 8px;
  padding: 20px;
  font-family: monospace;
  font-size: 14px;
  color: #00ff00;
  overflow-y: scroll; /* Ø¨Ø¯Ù„ auto */
  overflow-x: auto;
  box-shadow: inset 0 0 15px #eeff00;
  white-space: pre-wrap;
  max-width: 100%;
  word-wrap: break-word;
}
  #terminalInput {
    flex: 1;
    padding: 8px;
    font-family: monospace;
    font-size: 14px;
    border-radius: 6px;
    border: none;
    outline: none;
    background: #222;
    color: #eee;
  }
  #sendCmdBtn {
    background: #00c853;
    border: none;
    padding: 10px 15px;
    border-radius: 6px;
    color: #121212;
    font-weight: 600;
    cursor: pointer;
    transition: background 0.3s ease;
  }
  #sendCmdBtn:hover {
    background: #00e676;
  }

  /* ====== Ù‚Ø³Ù… Ù…Ø¯ÙŠØ± Ø§Ù„Ù…Ù„ÙØ§Øª ====== */
  #fileManager {
    flex: 1;
    background: #242424;
    border-radius: 8px;
    padding: 15px;
    color: #eee;
    display: none;
    flex-direction: column;
  }
  #fileManager header {
    font-size: 18px;
    margin-bottom: 10px;
    display: flex;
    align-items: center;
    gap: 10px;
  }
  #pathDisplay {
    background: #121212;
    padding: 8px 15px;
    border-radius: 6px;
    font-family: monospace;
    flex-grow: 1;
    user-select: text;
  }
  #filesList {
    flex: 1;
    overflow-y: auto;
    margin-top: 10px;
    background: #1e1e1e;
    border-radius: 6px;
    padding: 10px;
  }
  #filesList table {
    width: 100%;
    border-collapse: collapse;
  }
  #filesList th, #filesList td {
    padding: 8px 10px;
    border-bottom: 1px solid #333;
    text-align: right;
  }
  #filesList tr:hover {
    background-color: #333;
  }
  #filesList tr.directory {
    font-weight: bold;
    cursor: pointer;
  }
  #filesList tr.file {
    cursor: default;
  }
  #fileActions {
    margin-top: 15px;
    display: flex;
    gap: 10px;
  }
  #fileActions button {
    background: #00c853;
    border: none;
    padding: 10px 15px;
    font-size: 14px;
    border-radius: 6px;
    color: #121212;
    cursor: pointer;
    font-weight: 600;
    transition: background 0.3s ease;
  }
  #fileActions button:hover {
    background: #00e676;
  }
  #fileEditor {
    margin-top: 10px;
    background: #000;
    color: #0f0;
    font-family: monospace;
    border-radius: 6px;
    padding: 15px;
    height: 250px;
    overflow-y: auto;
    width: 100%;
  }
  input[type="file"] {
    display: none;
  }
</style>
<script src="/socket.io/socket.io.js"></script>
</head>
<body>

<header>Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ø³ÙŠØ±ÙØ± - Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</header>

<nav>
  <button id="btnControlPanel">Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</button>
  <button id="btnFileManager">Ù…Ø¯ÙŠØ± Ø§Ù„Ù…Ù„ÙØ§Øª</button>
</nav>

<main>
  <!-- Ù‚Ø³Ù… Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… -->
  <section id="controlPanel">
    <div style="display: flex; gap: 20px;">
      <div class="controls">
        <button id="startBtn" title="ØªØ´ØºÙŠÙ„ Ø§Ù„Ø³ÙŠØ±ÙØ±">â–¶ ØªØ´ØºÙŠÙ„ Ø§Ù„Ø³ÙŠØ±ÙØ±</button>
        <button id="stopBtn" title="Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø³ÙŠØ±ÙØ±" disabled>â–  Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø³ÙŠØ±ÙØ±</button>
      </div>
      <section id="consoleOutput" aria-live="polite" aria-label="Ø¥Ø®Ø±Ø§Ø¬ Ø§Ù„ÙƒÙˆÙ†Ø³Ù„"></section>
    </div>
    <div id="terminalInputContainer" style="display:flex; gap:10px; margin-top:10px;">
      <input id="terminalInput" type="text" placeholder="Ø§ÙƒØªØ¨ Ø£Ù…Ø±Ù‹Ø§..." autocomplete="off" />
      <button id="sendCmdBtn">Ø¥Ø±Ø³Ø§Ù„</button>
    </div>
  </section>

  <!-- Ù‚Ø³Ù… Ù…Ø¯ÙŠØ± Ø§Ù„Ù…Ù„ÙØ§Øª -->
  <section id="fileManager" aria-label="Ù…Ø¯ÙŠØ± Ø§Ù„Ù…Ù„ÙØ§Øª">
    <header>
      <div id="pathDisplay">/</div>
      <button id="btnUpDir" title="Ø§Ù„Ù…Ø¬Ù„Ø¯ Ø§Ù„Ø£Ø¹Ù„Ù‰">â¬†ï¸</button>
    </header>
    <div id="filesList"></div>

    <div id="fileActions">
      <button id="btnEditFile" disabled>ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ù„Ù</button>
      <button id="btnSaveFile" hidden>ğŸ’¾ Ø­ÙØ¸</button>
      <button id="btnDeleteFile" disabled>Ø­Ø°Ù</button>
      <button id="btnUploadFile">Ø±ÙØ¹ Ù…Ù„Ù</button>
      <input type="file" id="fileUploader" multiple />
    </div>

    <textarea id="fileEditor" hidden></textarea>
  </section>
</main>

<script>
  const socket = io();

  // Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…
  const startBtn = document.getElementById('startBtn');
  const stopBtn = document.getElementById('stopBtn');
  const consoleOutput = document.getElementById('consoleOutput');

  function updateButtons(isRunning) {
    startBtn.disabled = isRunning;
    stopBtn.disabled = !isRunning;
  }

  startBtn.addEventListener('click', () => socket.emit('start-server'));
  stopBtn.addEventListener('click', () => socket.emit('stop-server'));

  socket.on('console-output', data => {
    consoleOutput.textContent += data + '\n';
    consoleOutput.scrollTop = consoleOutput.scrollHeight;
  });
  socket.on('server-status', status => {
    consoleOutput.textContent += status ? '[Ø§Ù„Ø³ÙŠØ±ÙØ± ÙŠØ¹Ù…Ù„]\n' : '[Ø§Ù„Ø³ÙŠØ±ÙØ± Ù…ØªÙˆÙ‚Ù]\n';
    updateButtons(status);
  });
  updateButtons(false);

  // Ø£ÙˆØ§Ù…Ø± Ø§Ù„ØªÙŠØ±Ù…Ù†Ø§Ù„
  const terminalInput = document.getElementById('terminalInput');
  const sendCmdBtn = document.getElementById('sendCmdBtn');
  sendCmdBtn.addEventListener('click', sendCommand);
  terminalInput.addEventListener('keydown', e => { if(e.key === 'Enter') sendCommand(); });
  function sendCommand() {
    const cmd = terminalInput.value.trim();
    if(cmd) {
      socket.emit('send-command', cmd);
      terminalInput.value = '';
    }
  }

  // Ø§Ù„ØªØ¨Ø¯ÙŠÙ„ Ø¨ÙŠÙ† Ø§Ù„Ø£Ù‚Ø³Ø§Ù…
  const btnControlPanel = document.getElementById('btnControlPanel');
  const btnFileManager = document.getElementById('btnFileManager');
  const controlPanel = document.getElementById('controlPanel');
  const fileManager = document.getElementById('fileManager');
  btnControlPanel.addEventListener('click', () => {
    controlPanel.style.display = 'flex';
    fileManager.style.display = 'none';
  });
  btnFileManager.addEventListener('click', () => {
    controlPanel.style.display = 'none';
    fileManager.style.display = 'flex';
    loadFiles(currentPath);
  });

  // Ù…Ø¯ÙŠØ± Ø§Ù„Ù…Ù„ÙØ§Øª
  const pathDisplay = document.getElementById('pathDisplay');
  const btnUpDir = document.getElementById('btnUpDir');
  const filesList = document.getElementById('filesList');
  const btnEditFile = document.getElementById('btnEditFile');
  const btnSaveFile = document.getElementById('btnSaveFile');
  const btnDeleteFile = document.getElementById('btnDeleteFile');
  const btnUploadFile = document.getElementById('btnUploadFile');
  const fileUploader = document.getElementById('fileUploader');
  const fileEditor = document.getElementById('fileEditor');

  let currentPath = '/';
  let selectedFile = null;
  let selectedIsDirectory = false;

  function sanitizePath(path) {
    if (!path.startsWith('/')) path = '/' + path;
    return path;
  }

  function loadFiles(dirPath) {
    dirPath = sanitizePath(dirPath);
    fetch(`/api/files?path=${encodeURIComponent(dirPath)}`)
      .then(res => res.json())
      .then(data => {
        if(data.error) { alert(data.error); return; }
        currentPath = dirPath;
        pathDisplay.textContent = currentPath;
        renderFilesList(data.files);
        clearSelection();
        fileEditor.hidden = true;
        btnSaveFile.hidden = true;
        fileEditor.value = '';
      }).catch(() => alert('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„ÙØ§Øª'));
  }

  function renderFilesList(files) {
    let html = '<table><thead><tr><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„Ù†ÙˆØ¹</th></tr></thead><tbody>';
    for(let f of files) {
      html += `<tr tabindex="0" class="${f.isDirectory ? 'directory' : 'file'}" data-name="${f.name}" data-dir="${f.isDirectory}">
        <td>${f.name}</td>
        <td>${f.isDirectory ? 'Ù…Ø¬Ù„Ø¯' : 'Ù…Ù„Ù'}</td>
      </tr>`;
    }
    html += '</tbody></table>';
    filesList.innerHTML = html;

    const rows = filesList.querySelectorAll('tr');
    rows.forEach(row => {
      row.addEventListener('click', () => {
        selectFile(row.dataset.name, row.dataset.dir === 'true');
      });
      row.addEventListener('keydown', e => {
        if (e.key === 'Enter') selectFile(row.dataset.name, row.dataset.dir === 'true');
      });
      if (row.dataset.dir === 'true') {
        row.addEventListener('dblclick', () => {
          const newPath = currentPath === '/' ? `/${row.dataset.name}` : `${currentPath}/${row.dataset.name}`;
          loadFiles(newPath);
        });
      }
    });
  }

  function clearSelection() {
    selectedFile = null;
    selectedIsDirectory = false;
    btnEditFile.disabled = true;
    btnDeleteFile.disabled = true;
  }

  function selectFile(name, isDirectory) {
    selectedFile = name;
    selectedIsDirectory = isDirectory;
    btnDeleteFile.disabled = false;
    btnEditFile.disabled = isDirectory; // Ù„Ø§ ØªØ³Ù…Ø­ Ø¨ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ø¬Ù„Ø¯Ø§Øª
  }

  btnUpDir.addEventListener('click', () => {
    if(currentPath === '/') return;
    let parts = currentPath.split('/').filter(Boolean);
    parts.pop();
    let newPath = '/' + parts.join('/');
    if(newPath === '/') newPath = '/';
    loadFiles(newPath);
  });

  btnEditFile.addEventListener('click', () => {
    if(!selectedFile || selectedIsDirectory) return;
    fetch(`/api/file?path=${encodeURIComponent(currentPath)}&file=${encodeURIComponent(selectedFile)}`)
      .then(res => res.text())
      .then(text => {
        fileEditor.value = text;
        fileEditor.hidden = false;
        btnSaveFile.hidden = false;
      }).catch(() => alert('ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„Ù'));
  });

  btnSaveFile.addEventListener('click', () => {
    if(!selectedFile) return;
    fetch('/api/file', {
      method: 'PUT',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({
        path: currentPath,
        file: selectedFile,
        content: fileEditor.value
      })
    }).then(res => res.json())
      .then(data => {
        if(data.success) {
          alert('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…Ù„Ù Ø¨Ù†Ø¬Ø§Ø­');
          fileEditor.hidden = true;
          btnSaveFile.hidden = true;
        } else {
          alert('ÙØ´Ù„ Ø­ÙØ¸ Ø§Ù„Ù…Ù„Ù');
        }
      }).catch(() => alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­ÙØ¸ Ø§Ù„Ù…Ù„Ù'));
  });

  btnDeleteFile.addEventListener('click', () => {
    if(!selectedFile) return;
    if(!confirm(`Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù ${selectedFile}?`)) return;
    fetch('/api/file', {
      method: 'DELETE',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({ path: currentPath, file: selectedFile })
    }).then(res => res.json())
      .then(data => {
        if(data.success) {
          alert('ØªÙ… Ø§Ù„Ø­Ø°Ù Ø¨Ù†Ø¬Ø§Ø­');
          loadFiles(currentPath);
        } else {
          alert('ÙØ´Ù„ Ø§Ù„Ø­Ø°Ù');
        }
      }).catch(() => alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­Ø°Ù'));
  });

  btnUploadFile.addEventListener('click', () => {
    fileUploader.click();
  });

  fileUploader.addEventListener('change', () => {
    if(fileUploader.files.length === 0) return;
    const formData = new FormData();
    for(let i=0; i<fileUploader.files.length; i++) {
      formData.append('file', fileUploader.files[i]);
    }
    formData.append('path', currentPath);
    fetch('/api/upload', { method: 'POST', body: formData })
      .then(res => res.json())
      .then(data => {
        if(data.success) {
          alert('ØªÙ… Ø±ÙØ¹ Ø§Ù„Ù…Ù„Ù/Ø§Ù„Ù…Ù„ÙØ§Øª');
          loadFiles(currentPath);
          fileUploader.value = '';
        } else {
          alert('ÙØ´Ù„ Ø±ÙØ¹ Ø§Ù„Ù…Ù„Ù/Ø§Ù„Ù…Ù„ÙØ§Øª: ' + (data.error || ''));
        }
      }).catch(() => alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø±ÙØ¹ Ø§Ù„Ù…Ù„Ù/Ø§Ù„Ù…Ù„ÙØ§Øª'));
  });

  // Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©ØŒ Ø¥Ø¸Ù‡Ø§Ø± Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ø£ÙˆÙ„Ø§Ù‹
  controlPanel.style.display = 'flex';
  fileManager.style.display = 'none';
  loadFiles(currentPath);
</script>

</body>
</html>
